---
title: "Applied Microdata Analysis for Workforce Trends"
author: "From Raw Data to Regional Insights: Intermediate R Tools for Workforce & Economic Development"
date: "Nov 19-20, 2025"
output:
  html_document:
    css: assets/rany_style.css
    df_print: paged
    highlight: tango
    theme: cosmo
    toc: yes
    toc_float:
      collapsed: true
    number_sections: false
---

```{r setup, include=FALSE}
# Global chunk options for this document
knitr::opts_chunk$set(
  echo    = TRUE,   # show code by default so participants can follow
  warning = FALSE,  # hide warnings in the knitted HTML
  message = FALSE   # hide messages (e.g., package loading messages)
)

# Load all packages used in this section of the training
library(tidycensus)  # access ACS, PUMS, and related Census data
library(dplyr)       # data manipulation: filter, mutate, summarize, joins
library(tidyr)       # data reshaping and tidying
library(tigris)      # Census TIGER/Line shapefiles (PUMAs, tracts, counties)
library(tmap)        # thematic mapping (static and interactive maps)
library(ggplot2)     # plotting framework (for charts, if needed)
```


# Introduction

Most data that we access through `tidycensus` comes from the pre-aggregated ACS tables. These tables are already summarized by the Census Bureau at standard geographic levels (tract, county, state, etc.). For example, when we run `get_acs()`, we are retrieving values like total population, median income, or housing characteristics that the Census has already calculated and published.

For many use cases, these pre-built tables are all we need. But the ACS also provides microdata, known as the **Public Use Microdata Sample (PUMS)**. This microdata contains individual-level survey responses—the raw inputs used to construct the published ACS tables.

Why does this matter for our work?

- PUMS allows us to build custom tabulations not available in pre-aggregated tables.
- We can model outcomes using individual-level data rather than tract- or county-level summaries.
- It offers more flexibility when we need custom breakouts for agency analysis.

However, PUMS comes with a trade-off: it provides limited geography. Each record is identified only by state and PUMA (**Public Use Microdata Area**), a Census-defined area with at least 100,000 people. PUMAs do not always match county or city boundaries, so PUMS cannot be used for block-group or tract-level analysis.

Now, PUMS data is available via web API, which means you can easily access it in R by using `tidycensus.`

# 1. Getting Started with `tidycensus` and PUMS

In this section, we:

- Set up the Census API key for `tidycensus`.
- Explore the `pums_variables` dictionary to understand variable names and codes.
- Focus on **ACS PUMS microdata**, which provides person- and household-level records.

## 1.1 Setting up `tidycensus`

To use `tidycensus`, you need a Census API key.

1. Request a key at: https://api.census.gov/data/key_signup.html  
2. Click the confirmation link sent to your email.  
3. Store the key securely (e.g., as an environment variable `CENSUS_API_KEY`).

```{r, results = "hide"}
# This assumes you have stored your key in an environment variable named "CENSUS_API_KEY".
#   Sys.setenv(CENSUS_API_KEY = "YOUR_OWN_KEY_HERE")
census_api_key(Sys.getenv("CENSUS_API_KEY"), install  = TRUE, overwrite = TRUE)
```

## 1.2 Exploring `pums_variables`

`pums_variables` is a built-in data frame in `tidycensus` that describes:

- Variable names (e.g., `AGEP`, `SCHL`, `OCCP`)
- Labels / descriptions
- Valid codes and categories
- Year and survey information (ACS 1-year or 5-year)

```{r}
# View the full PUMS variable dictionary
# In RStudio, this opens in the "Data Viewer" for easier browsing.
View(pums_variables)
```

Because PUMS variables and codes can change by year and survey, it is good practice to filter to the specific year and survey first.  
Below, we focus on the **2023 ACS 1-year** PUMS variables.

```{r}
pums_vars_2023 <- pums_variables %>% 
  filter(
    year   == 2023,  # target year
    survey == "acs1" # ACS 1-year survey
  )

# View 2023 ACS 1-year PUMS variable metadata
View(pums_vars_2023)
```

### Exercises: Variable Discovery

1. Find education-related variables in `pums_vars_2023` (e.g., `SCHL`).  
2. Locate the `SCHL` codes used for educational attainment (e.g., HS, BA, graduate degrees).  
3. Explore occupation-related variables such as `OCCP` (detailed occupation) and `SOCP` (Standard Occupational Classification).  

---

# 2. Downloading ACS PUMS Microdata

ACS PUMS provides **microdata** at the person and household level.  
This allows:

- Custom cross-tabs and indicators (beyond published tables)
- Flexible definitions of workforce outcomes
- Regional analysis at PUMA level

## 2.1 Basic usage of `get_pums()`

We start with a simple pull for New Jersey using the 2019 ACS 1-year PUMS.

```{r, results = "hide"}
nj_pums <- get_pums(
  variables = c("SEX", "AGEP", "HHT"),  # variables of interest
  state     = "NJ",                     # two-letter state abbreviation
  survey    = "acs1",                   # ACS 1-year PUMS
  year      = 2019                      # reference year
)
```

```{r}
# Look at the first few rows of the PUMS data
# Note: This is person-level microdata, not pre-tabulated ACS tables.
head(nj_pums)
```

### Exercises: Basic PUMS

1. Change the `year` to **2021** and re-run `get_pums()`.  
2. Add `"MAR"` (marital status) to `variables` and inspect the results.  
3. Use `dplyr::select()` to keep only `SEX`, `AGEP`, `HHT`, `PWGTP` for a clean working subset.  

Example (for participants to try):

```{r}
nj_pums_small <- nj_pums %>%
  select(SEX, AGEP, HHT, PWGTP)
```

## 2.2 Identifiers and Weights in PUMS

Every `get_pums()` call includes identifiers and weights automatically:

- `SERIALNO` — household ID (ties people to households)  
- `SPORDER` — person number within the household  
- `WGTP` — household weight  
- `PWGTP` — person weight (use this for person-level estimates)  

When you compute statistics for people (e.g., number of workers, education levels), use `PWGTP` as the weight.

```{r}
# Example: Quick check of weights vs. raw counts
nj_pums %>%
  count(SEX, wt = PWGTP, name = "weighted_people") %>%   # weighted count
  mutate(
    unweighted_people = n() / n_distinct(SEX)  # simplistic raw illustration
  )
```

*(The unweighted calculation above is just didactic; in practice, compare `n()` vs. `sum(PWGTP)` directly.)*

### Exercises: Weights

1. Generate a **weighted age distribution** using:  
   `nj_pums %>% count(AGEP, wt = PWGTP)`  
2. Estimate the number of **children under 18** in NJ using:  
   `nj_pums %>% filter(AGEP < 18) %>% summarize(pop_under18 = sum(PWGTP))`  
3. Compare `n()` vs `sum(PWGTP)` and explain the difference between **sample counts** and **population estimates**.  

---

# 3. Enhancing PUMS Pulls: Labels and Filters

Next, we make the microdata easier to interpret and more efficient to work with.

## 3.1 Recoded variables (`recode = TRUE`)

Using `recode = TRUE` adds human-readable label columns such as:

- `SEX_label` (e.g., *Male*, *Female*)
- `SCHL_label` (e.g., *High school graduate*, *Bachelor's degree*)

while keeping the original coded variables.

```{r, results = "hide"}
nj_pums_recoded <- get_pums(
  variables = c("SEX", "AGEP", "SCHL"),
  state     = "NJ",
  survey    = "acs1",
  year      = 2019,
  recode    = TRUE  # adds *_label columns
)

# View the structure to see both coded and labeled versions
str(nj_pums_recoded)
```

```{r}
# Peek at a few rows to see the label columns
head(
  nj_pums_recoded %>%
    select(SEX, SEX_label, SCHL, SCHL_label, AGEP, PWGTP)
)
```

### Exercises: Recoded Labels

1. Count population by `SEX_label` using person weights:  
   `nj_pums_recoded %>% count(SEX_label, wt = PWGTP)`  
2. Count population by `SCHL_label` for adults age 25+ only.  
3. Sort education categories by total population to identify the dominant education levels.  

Participants can try:

```{r}
nj_pums_recoded %>%
  filter(AGEP >= 25) %>%
  count(SCHL_label, wt = PWGTP, sort = TRUE)
```

## 3.2 Filtering at the API (`variables_filter`)

For large PUMS pulls, you do **not** always want the entire dataset.  
`variables_filter` lets you filter records *before* they are returned from the API.

Below, we:

- Restrict to **females** (`SEX = 2`)
- With **some college or higher** (`SCHL` codes 16–20)

```{r, results = "hide"}
nj_pums_filtered <- get_pums(
  variables = c("SEX", "AGEP", "SCHL"),
  state     = "NJ",
  survey    = "acs5",             # 5-year ACS PUMS (larger sample)
  variables_filter = list(
    SEX  = 2,                     # 2 = Female
    SCHL = 16:20                  # some college, associate, BA, etc.
  ),
  year   = 2019,
  recode = TRUE                   # keep label columns for easier interpretation
)
```

```{r}
# Check how many rows are in the filtered subset
nrow(nj_pums_filtered)

# Inspect a few observations
head(
  nj_pums_filtered %>%
    select(SEX_label, AGEP, SCHL, SCHL_label, PWGTP)
)
```

### Exercises: Filter at API

1. Filter for **males (SEX = 1)** with **high school or less** (`SCHL` codes typically <= 15; participants can confirm using `pums_variables`).  
2. Compare `nrow()` of your full `nj_pums` vs. the filtered version to see how much data you have reduced.

---

# 4. Analyzing and Summarizing PUMS Data

In this section, we move from raw microdata to **PUMA-level workforce indicators**, a key use case for regional workforce analysis. Note: ACS 2019 uses **2010-based PUMAs**, which align with the 2019 PUMA shapefiles from `tigris`.

```{r, results = "hide"}
nj_pums <- get_pums(
  variables = c("PUMA", "SEX", "AGEP", "SCHL"),
  state     = "NJ",
  survey    = "acs5",   # 5-year ACS PUMS for more stable small-area estimates
  year      = 2019,
  recode    = TRUE      # useful for labels in summaries
)
```

```{r}
# Quick example: weighted counts by sex and age
nj_pums %>% 
  count(SEX_label, AGEP, wt = PWGTP) 
```

## 4.1 Group-wise summary: BA+ attainment by PUMA and sex

We will compute:

- Total population by PUMA and sex  
- Mean age by PUMA and sex  
- Number and share of adults 25+ with **BA or higher**  

`SCHL` codes for BA+ (confirm in `pums_variables`):

- 21 = Bachelor's degree  
- 22 = Master's degree  
- 23 = Professional school degree (JD, MD, etc.)  
- 24 = Doctorate degree  

```{r, results = "hide"}
nj_pums_summary <- nj_pums %>%
  mutate(
    ba_above = ifelse(SCHL %in% c("21", "22", "23", "24"), 1, 0)  # Create a dummy variable for BA+ education
  ) %>%
  group_by(PUMA, SEX_label) %>%
  summarize(
    total_pop = sum(PWGTP),                                       # Person-weighted total population by PUMA and sex
    mean_age  = weighted.mean(AGEP, PWGTP),                       # Person-weighted mean age by PUMA and sex
    ba_above = sum(PWGTP[ba_above == 1 & AGEP >= 25]),             # Person-weighted count of adults 25+ with BA or higher by PUMA and sex
    ba_above_pct = 100 * ba_above / sum(PWGTP[AGEP >= 25]),       # Percentage of adults 25+ with BA+ by PUMA and sex
    .groups = "drop"
  )
```

```{r}
# View the PUMA-level summary table
head(nj_pums_summary)
```

### Exercises: Group Summaries

1. Define a dummy variable for **high school or less** (e.g., `SCHL` codes up to HS) and compute its percentage by PUMA and sex.  
2. Restrict the analysis to **prime-age adults (25–54)** and recompute BA+ shares.  
3. Among females, identify which PUMA has the highest BA+ % and discuss potential workforce implications.  

Participants can try:

```{r}
nj_pums_summary %>%
  filter(SEX_label == "Female") %>%
  arrange(desc(ba_above_pct)) %>%
  head()
```

---

# 5. Mapping PUMS Indicators by PUMA

Now we bring together:

- PUMA-level indicators from PUMS  
- PUMA boundary shapefiles from `tigris`  

to create a **workforce skills map**.

## 5.1 Downloading PUMA boundaries

```{r, results = "hide"}
# Cache geometries locally to avoid repeated downloads
options(tigris_use_cache = TRUE)

# PUMAs for New Jersey (2010-based PUMAs used with 2019 ACS)
nj_pumas <- pumas(
  state = "NJ",
  cb    = TRUE,    # use generalized (cartographic) boundaries – simpler shapes
  year  = 2019
)
```

```{r}
# Check the PUMA shapefile structure
nj_pumas
```

## 5.2 Joining PUMS summaries to PUMA geography

We join on:

- `PUMACE10` in the shapefile (2010 PUMA code)
- `PUMA` in the PUMS summary

Then, as an example, we filter to **females** only.

```{r}
joined_pumas <- nj_pumas %>%
  left_join(
    nj_pums_summary,
    by = c("PUMACE10" = "PUMA")
  ) %>%
  filter(SEX_label == "Female")
```

```{r}
# Check that join worked and BA+ variables are present
head(
  joined_pumas %>%
    select(PUMACE10, NAME10, SEX_label, ba_above_pct)
)
```

## 5.3 Mapping BA+ attainment with `tmap`

We map:

- Variable: `ba_above_pct` (% of women age 25+ with BA+)  
- Geography: PUMA boundaries  
- Palette: `"Blues"` (you can experiment with others)

```{r}
# Use plot mode for static maps (suitable for knitted HTML/PDF)
tmap_mode("plot")

tm_shape(joined_pumas) +
  tm_polygons(
    col     = "ba_above_pct",            # variable to map
    palette = "Blues",                   # color palette
    style   = "quantile",                # classification style (e.g., quantile)
    title   = "% of women with\ncollege degree (BA+)"
  ) +
  tm_layout(
    legend.outside          = TRUE,
    legend.outside.position = "right",
    main.title              = "Women with BA+ by PUMA, New Jersey (ACS PUMS 2019)",
    main.title.size         = 1.1
  )
```

### Exercises: Mapping PUMS

1. Remove `filter(SEX_label == "Female")` and map **all sexes combined** (you may need to recompute summaries without splitting by sex).  
2. Create a separate map for men only and compare visually with the women's map.  
3. Change `palette` to `"Viridis"` or `"Reds"` and discuss how color choices affect interpretation.  
4. (Optional) Switch to interactive mode with `tmap_mode("view")` and explore the regions.  

---

# Wrap-Up: Applied Microdata for Workforce Trends

In this session, we:

- Set up `tidycensus` with a Census API key.  
- Explored PUMS variable metadata using `pums_variables`.  
- Pulled ACS PUMS microdata with `get_pums()` for New Jersey.  
- Interpreted identifiers and weights (`PWGTP`) to produce population-representative estimates.  
- Used `recode = TRUE` to work with readable label columns.  
- Applied `variables_filter` to efficiently restrict large PUMS pulls at the API.  
- Aggregated microdata to create **PUMA-level workforce indicators** (e.g., BA+ attainment).  
- Joined PUMS summaries with PUMA shapefiles from `tigris` and mapped results using `tmap`.  

These steps form a reusable workflow for **applied microdata analysis** in workforce and economic development contexts:

1. **Define your question.**  
2. **Find the right variables.**  
3. **Pull microdata with proper weights.**  
4. **Summarize to the right geographic unit.**  
5. **Visualize patterns to inform policy and program decisions.**  
